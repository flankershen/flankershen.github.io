<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>STP协议详解 | connect();</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="STP协议详解

生成树协议（Spanning Tree Protocol，STP），是一种基于OSI网络参考模型的数据链路层的通讯协议，用来确保一个无环路的LAN环境。
基于由Radia Perlman在DEC工作时发明的算法，STP让一个网络被设计成包含备用线路以当一条活动中的线路失效时，自动提供备用线路，並排除引起环路、及手动启动、关闭該些备用线路的需要。
因此，通过使用STP，可以达到四个">
<meta property="og:type" content="article">
<meta property="og:title" content="STP协议详解">
<meta property="og:url" content="http://super-flanker.com/2017/04/14/STP协议详解/index.html">
<meta property="og:site_name" content="connect();">
<meta property="og:description" content="STP协议详解

生成树协议（Spanning Tree Protocol，STP），是一种基于OSI网络参考模型的数据链路层的通讯协议，用来确保一个无环路的LAN环境。
基于由Radia Perlman在DEC工作时发明的算法，STP让一个网络被设计成包含备用线路以当一条活动中的线路失效时，自动提供备用线路，並排除引起环路、及手动启动、关闭該些备用线路的需要。
因此，通过使用STP，可以达到四个">
<meta property="og:image" content="http://super-flanker.com/./image.png">
<meta property="og:image" content="http://super-flanker.com/./image.png">
<meta property="og:image" content="http://super-flanker.com/./image.png">
<meta property="og:updated_time" content="2017-04-14T03:12:37.432Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STP协议详解">
<meta name="twitter:description" content="STP协议详解

生成树协议（Spanning Tree Protocol，STP），是一种基于OSI网络参考模型的数据链路层的通讯协议，用来确保一个无环路的LAN环境。
基于由Radia Perlman在DEC工作时发明的算法，STP让一个网络被设计成包含备用线路以当一条活动中的线路失效时，自动提供备用线路，並排除引起环路、及手动启动、关闭該些备用线路的需要。
因此，通过使用STP，可以达到四个">
<meta name="twitter:image" content="http://super-flanker.com/./image.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'> -->
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css"> -->
  <link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-96458908-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="/" class="logo">connect();</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about/about.html">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://super-flanker.com"></form>
        </div>
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/flankershen" title="Fork me on GitHub"></a>
        
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about/about.html" class="mobile-nav-link">About</a>
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://super-flanker.com"></form>
  </div>
</nav>
      <div class="outer">
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/14/STP协议详解/">STP协议详解</a>
          </li>
        
          <li>
            <a href="/2017/03/30/SNMP配置及命令参数/">SNMP配置及命令参数</a>
          </li>
        
          <li>
            <a href="/2017/03/30/ZTE交换路由设备配置的备份与恢复/">ZTE交换路由设备配置的备份与恢复</a>
          </li>
        
          <li>
            <a href="/2017/03/30/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SNMP/">SNMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZTE/">ZTE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络协议/">网络协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络配置/">网络配置</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SNMP/" style="font-size: 10px;">SNMP</a> <a href="/tags/ZTE/" style="font-size: 10px;">ZTE</a> <a href="/tags/网络协议/" style="font-size: 10px;">网络协议</a> <a href="/tags/网络配置/" style="font-size: 20px;">网络配置</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://hexo.io">Hexo</a>
          </li>
        
          <li>
            <a href="http://github.com">github</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
        <section id="main"><article id="pages-STP协议详解" class="article article-type-pages" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/STP协议详解/" class="article-date">
  <time datetime="2017-04-14T03:08:43.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/网络/">网络</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      STP协议详解
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="STP协议详解"><a href="#STP协议详解" class="headerlink" title="STP协议详解"></a>STP协议详解</h2><hr>
<blockquote>
<p><strong>生成树协议</strong>（<strong>Spanning Tree Protocol</strong>，<strong>STP</strong>），是一种基于OSI网络参考模型的数据链路层的通讯协议，用来确保一个无环路的LAN环境。</p>
<p>基于由<a href="https://zh.wikipedia.org/w/index.php?title=Radia_Perlman&amp;action=edit&amp;redlink=1" target="_blank" rel="external">Radia Perlman</a>在<a href="https://zh.wikipedia.org/wiki/DEC" target="_blank" rel="external">DEC</a>工作时发明的算法，STP让一个网络被设计成包含备用线路以当一条活动中的线路失效时，自动提供备用线路，並排除引起环路、及手动启动、关闭該些备用线路的需要。</p>
<p>因此，通过使用STP，可以达到四个效果：</p>
<p>1、防止环路；</p>
<p>2、防止<a href="https://zh.wikipedia.org/wiki/MAC%E5%9C%B0%E5%9D%80" target="_blank" rel="external">MAC地址</a>震荡；</p>
<p>3、防止重复<a href="https://zh.wikipedia.org/wiki/%E5%B8%A7" target="_blank" rel="external">帧</a>的出现；</p>
<p>4、防止<a href="https://zh.wikipedia.org/wiki/%E5%BB%A3%E6%92%AD%E9%A2%A8%E6%9A%B4" target="_blank" rel="external">广播风暴</a>的出现。</p>
<p>—来自WIKI百科 </p>
</blockquote>
<h3 id="交换环路从何而来"><a href="#交换环路从何而来" class="headerlink" title="交换环路从何而来"></a>交换环路从何而来</h3><p>当交换机之间存在多条活动链路时，交换机将从不正常的接口上学习到MAC地址，导致MAC地址表的不正确与不稳定，并且还会导致重复的数据包在网络中传递，引起广播风暴，使网络不稳定。</p>
<p>为了防止交换机之间由于多条活动链路而导致的网络故障，必须将多余的链路置于非活动状态，即不转发用户数据包，而只留下单条链路作为网络通信，当唯一的活动链路不能工作时，再启用非活动链路，从而达到网络的冗余性。要实现此功能，需要依靠生成树协议（STP）来完成，STP将交换网络中任何两个点之间的多余链路置于Blocking（关闭）状态，而只留一条活动链路，当使用中的活动链路失效时，立即启用被Block的链路，以此来提供网络的冗余效果。</p>
<h3 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h3><hr>
<p>  STP为IEEE标准协议，并且有多个协议版本，版本与协议号的对应关系如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Name</th>
<th style="text-align:center">IEEE No.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Common Spanning Tree(CST)</td>
<td style="text-align:center">IEEE 802.1D</td>
</tr>
<tr>
<td style="text-align:center">Rapid Spanning Tree Protocol</td>
<td style="text-align:center">IEEE 802.1W</td>
</tr>
<tr>
<td style="text-align:center">Per-VLAN Spanning Tree plus(PVST+)</td>
<td style="text-align:center">per-VLAN IEEE 802.1D</td>
</tr>
<tr>
<td style="text-align:center">Rapid PVST+</td>
<td style="text-align:center">per-VLAN IEEE 802.1D</td>
</tr>
<tr>
<td style="text-align:center">Multiple Spanning Tree Protocol(MSTP)</td>
<td style="text-align:center">IEEE 802.1S</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="工作原理及过程"><a href="#工作原理及过程" class="headerlink" title="工作原理及过程"></a>工作原理及过程</h3><hr>
<h4 id="STP的相关名词介绍："><a href="#STP的相关名词介绍：" class="headerlink" title="STP的相关名词介绍："></a>STP的相关名词介绍：</h4><h5 id="1、根交换机"><a href="#1、根交换机" class="headerlink" title="1、根交换机"></a>1、根交换机</h5><blockquote>
<p>网桥ID（BID）：</p>
<p>​    优先级+网桥MAC</p>
<p>​    优先级（2Byte）：前4bit表示优先级，后8bit作为System ID,为协议扩展用。越小越好，必须为4096的倍数。</p>
<p>​    网桥MAC（6Byte）</p>
<p>网桥ID在同一个广播域内是唯一的。</p>
</blockquote>
<ul>
<li>根桥的选举依据<ul>
<li>先查看交换机优先级，优先选择优先级数值小的优先级高的可以忽略mac数值。（优先级可以通过配置1修改缺省值：32768）<ul>
<li>取值范围：0 ～ 65535</li>
<li>缺省值：32768</li>
</ul>
</li>
<li>然后查看交换机的Mac地址，选择数值小的</li>
</ul>
</li>
</ul>
<h5 id="2、命令及验证"><a href="#2、命令及验证" class="headerlink" title="2、命令及验证"></a>2、命令及验证</h5><p><img src="./image.png" alt="Alt text"></p>
<p>自动选举出根交换机，使用下面的命令验证：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line"> * 在SW1上查看生成树信息，因为SW1、SW2、SW3上面都没有划分其他的VLAN，</div><div class="line"> * 所以默认只有VLAN0001的生成树信息。</div><div class="line"> *</div><div class="line"> * &quot;Spanning tree enabled protocol ieee&quot;,</div><div class="line"> * 表示交换机使用的生成树协议是&quot;PVST+&quot;,这也是思科默认的生成树协议。</div><div class="line"> *</div><div class="line"> * &quot;Root ID&quot;后面是VLAN1中根交换机的BID参数，</div><div class="line"> * Priority 32769，表示根交换机的优先级是32769，</div><div class="line"> * Address是根交换机的MAC地址，</div><div class="line"> * &quot;This bridge is the root&quot;，表示当前这台交换机就是根交换机。</div><div class="line"> *</div><div class="line"> * &quot;Hello Time  2sec  Max Age 20sec  Forward Delay 15sec&quot;</div><div class="line"> * BPDU发送间隔默认2秒，最大存在时间是20秒，转发延时是15秒。</div><div class="line"> *</div><div class="line"> * &quot;Bridge ID&quot;后面的参数是本交换机的BID参数，</div><div class="line"> * 因为SW1就是根交换机，所以下面的参数和&quot;Root ID&quot;是一样的，</div><div class="line"> * 其中&quot;priority 32768 sys-id-ext 1&quot;,表示SW1的优先级是32768,</div><div class="line"> * Extended System ID是1，所以总优先级就是32768+1=32769。</div><div class="line"> *</div><div class="line"> * 所以SW1的BID=SW1的优先级+SW1的MAC地址=32769+0001.9681.2683</div><div class="line"> * 接下来查看SW2和SW3的生成树信息，就会知道为什么SW1可以被选举成根交换机了。</div><div class="line"> */</div><div class="line">SW1#show spanning-tree</div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    32769    </div><div class="line">  			 Address     0001.9681.2683</div><div class="line">             This bridge is the root</div><div class="line">             Hello Time  2 ec  Max Age 20sec  Forward Delay 15sec</div><div class="line"> </div><div class="line">  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)</div><div class="line">             Address     0001.9681.2683</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line">             Aging Time  20</div><div class="line"></div><div class="line">Interface   Role Sts Cost      Prio.Nbr Type</div><div class="line">----------- ---- --- --------- -------- ----------</div><div class="line">Fa0/1       Desg FWD 19        128.1    P2p</div><div class="line">Fa0/2       Desg FWD 19        128.2    P2p</div><div class="line">Fa0/3       Desg FWD 19        128.3    P2p</div><div class="line"> </div><div class="line">/*</div><div class="line"> * 查看SW2的生成树信息，</div><div class="line"> *</div><div class="line"> * 可以看到SW2的BID中，优先级是32769，和SW1相同，</div><div class="line"> * 但SW2的MAC地址是0030.A310.3975，大于SW1的MAC地址，</div><div class="line"> * 因为BID=优先级+MAC地址，</div><div class="line"> * SW1的BID要小于SW2的BID，</div><div class="line"> * 所以SW1为根交换机。</div><div class="line"> */</div><div class="line">SW2#show spanning-tree</div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line"> </div><div class="line">/*这里是根交换机，也就是SW1的BID信息*/</div><div class="line">  Root ID    Priority    32769</div><div class="line">             Address     0001.9681.2683</div><div class="line">             Cost        19</div><div class="line">             Port        2(FastEthernet0/2)</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line"> </div><div class="line">/*这里是SW2的BID*/</div><div class="line">  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)</div><div class="line">             Address     0030.A310.3975</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line">             Aging Time  20</div><div class="line"> </div><div class="line">/*查看SW3的生成树信息，优先级相同，同样是因为MAC地址比SW1大*/</div><div class="line">SW3#show spanning-tree</div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    32769</div><div class="line">             Address     0001.9681.2683</div><div class="line">             Cost        19</div><div class="line">             Port        1(FastEthernet0/1)</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line"> </div><div class="line">  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)</div><div class="line">             Address     00E0.8F76.269C</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line">             Aging Time  20</div></pre></td></tr></table></figure>
<p>可以通过下面的命令将某台交换机的优先级改小，或者设置成动态优先级（即永远比其它交换机的优先级小），这样这台拥有较小优先级的交换机将成为根交换机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*首先我随便配置一个优先级*/</div><div class="line">SW3(config)#spanning-tree vlan 1 priority 1000</div><div class="line"> </div><div class="line">/*它提示我，只能是4096的倍数，可以是下面的这些值*/</div><div class="line">% Bridge Priority must be in increments of 4096.</div><div class="line">% Allowed values are:</div><div class="line">  0     4096  8192  12288 16384 20480 24576 28672</div><div class="line">  32768 36864 40960 45056 49152 53248 57344 61440</div><div class="line"> </div><div class="line">/*</div><div class="line"> * 本例设置成4096，注意设置针对的是VLAN1，</div><div class="line"> * 不同的VLAN优先级可以不同，</div><div class="line"> * 不同VLAN的STP选举出来的根交换机也可以不同，</div><div class="line"> * 比如SW3现在是VLAN1的根交换机，</div><div class="line"> * 假设还存在一个VLAN2，并且在SW1上使用这条命令:</div><div class="line"> * spanning-tree vlan 2 priority 4096</div><div class="line"> * 那么SW1就将成为VLAN2的根交换机，前提是VLAN2下有端口。</div><div class="line"> */</div><div class="line">SW3(config)#spanning-tree vlan 1 priority 4096</div><div class="line">SW3(config)#end</div><div class="line"> </div><div class="line">/*过个一两秒，查看SW3的生成树信息，发现他已经成为了根交换机。*/</div><div class="line">SW3#show spanning-tree</div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    4097</div><div class="line">             Address     00E0.8F76.269C</div><div class="line">             This bridge is the root</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line"> </div><div class="line">  Bridge ID  Priority    4097  (priority 4096 sys-id-ext 1)</div><div class="line">             Address     00E0.8F76.269C</div><div class="line">             Hello Time  2sec  Max Age 20sec  Forward Delay 15sec</div><div class="line">             Aging Time  20</div></pre></td></tr></table></figure>
<p>使用下面的命令可以让交换机自动动态的调整自己的优先级为整个广播域最小，使用这条命令让SW2成为vlan1的根交换机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*首先清除SW3上面手动配置的优先级*/</div><div class="line">SW3(config)#no spanning-tree vlan 1 priority</div><div class="line"> </div><div class="line">/*在SW2上配置自动调整优先级，让SW2动态调整*/</div><div class="line">SW2(config)#spanning-tree vlan 1 root primary</div><div class="line"> </div><div class="line">/*等待几秒钟，查看SW2的生成树信息,发现根交换机变成了自己*/</div><div class="line">SW2#show spanning-tree</div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    16385</div><div class="line">             Address     0030.A310.3975</div><div class="line">             This bridge is the root</div></pre></td></tr></table></figure>
<h5 id="3、端口花费和路径花费"><a href="#3、端口花费和路径花费" class="headerlink" title="3、端口花费和路径花费"></a>3、端口花费和路径花费</h5><p>根交换机被选举出来后，计算其他交换机到根交换机的花费，STA考虑两种花费，<strong>端口花费</strong>和<strong>路径花费</strong>，<strong>路径花费是从根交换机出发到最终交换机前进方向进入的端口花费总和</strong>。假设SW1是根交换机，SW1的fa0/3连接SW3的fa0/1，想要改变SW3到根交换机SW1的花费，应该在SW3的fa0/1来改变，而不是在SW1的fa0/3端口上改变。</p>
<p>如果一台交换机有多条路径到达根交换机，这台交换机会选择路径花费最小的那条</p>
<blockquote>
<p>根路径开销：</p>
<p>本交换机到达根交换机的总开销，越小越好，开销与带宽有关。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">Link Speed</th>
<th style="text-align:center">Cost(New IEEE Specification)</th>
<th style="text-align:center">*Cost(Old IEEE Specification)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10Gb/s</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">1Gb/s</td>
<td style="text-align:center">4</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">100Mb/s</td>
<td style="text-align:center">19</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">10Mb/s</td>
<td style="text-align:center">100</td>
<td style="text-align:center">100</td>
</tr>
</tbody>
</table>
<p><img src="./image.png" alt="Alt text"></p>
<p>先在SW3上面查看一下默认的生成树信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SW3#show spanning-tree</div><div class="line"> </div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    32769</div><div class="line">             Address     aabb.cc00.0100</div><div class="line">/*</div><div class="line"> * 可以看到IOU3到根交换机的花费是100，</div><div class="line"> * 这说明SW3的e0/2接口速率是10Mb/s。</div><div class="line"> */</div><div class="line">             Cost        100</div><div class="line">             Port        3 (Ethernet0/2)</div></pre></td></tr></table></figure>
<p>尝试修改SW3的e0/2接口到根交换机的花费：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SW3#conf t</div><div class="line">/*将IOU3的e0/2接口花费改成300*/</div><div class="line">SW(config)#int e0/2</div><div class="line">SW3(config-if)#spanning-tree cost 300</div><div class="line">SW3(config-if)#end</div><div class="line"> </div><div class="line">/*</div><div class="line"> * 再次查看SW3的生成树信息，发现花费居然变成了200，</div><div class="line"> * 这是为什么呢？不是应该为300吗？</div><div class="line"> * 另外还发现下面的Port端口也发生了变化，</div><div class="line"> * 没有修改前是e0/2，现在是e0/3,</div><div class="line"> * 这说明去往根交换机的数据是通过SW3的e0/3发给IOU2再转发给IOU1的，</div><div class="line"> * 这是因为我们将SW3的e0/2的花费修改成了300，</div><div class="line"> * 然而，通过SW3的e0/3发给SW2再转发给SW1的花费只有200，</div><div class="line"> * 即SW3的e0/3的默认花费100，加上SW2的e0/0的默认花费100，</div><div class="line"> * 前面也提到了，交换机选取花费最小的那条路径去往根交换机。</div><div class="line"> */</div><div class="line">SW3#show spanning-tree</div><div class="line"> </div><div class="line">VLAN0001</div><div class="line">  Spanning tree enabled protocol ieee</div><div class="line">  Root ID    Priority    32769</div><div class="line">             Address     aabb.cc00.0100</div><div class="line">             Cost        200</div><div class="line">             Port        4 (Ethernet0/3)</div></pre></td></tr></table></figure>
<h5 id="4、BPDU结构"><a href="#4、BPDU结构" class="headerlink" title="4、BPDU结构"></a>4、BPDU结构</h5><p>BPDU包含12个字段：</p>
<ul>
<li>Protocol ID （2字节）</li>
<li>Version （1字节）</li>
<li>Message type（1字节）</li>
</ul>
<ul>
<li>Flags：标记域,包含TC（Topology Change，拓扑改变）比特位，TCA(Topology Change Acknowledgment,拓扑改变确认)比特位。（1字节）</li>
<li>Root ID：包含了根交换机的BID。（8字节）</li>
<li>Cost of path：到根交换机的路径花费。（4字节）</li>
<li>Bridge ID：转发BPDU的交换机的BID。（8字节）</li>
<li>Port ID：转发BPDU的交换机的PID，PID等于端口优先级(默认128)加端口号，后面会介绍到。（2字节）</li>
<li>Message age：BPDU已经存在的时间。（2字节）</li>
<li>Max age：BPDU最大存在时间。（2字节）</li>
<li>Hello time：根交换机发送配置信息的间隔时间，默认2秒。（2字节）</li>
<li>Forward Delay：转发延时，默认15秒。（2字节）</li>
</ul>
<h5 id="5、端口角色"><a href="#5、端口角色" class="headerlink" title="5、端口角色"></a>5、端口角色</h5><ul>
<li>根端口(Root Port,RP)：每个<strong>非根交换机</strong>上有且仅有一个根端口，稍后的生成树选举中会详细介绍根端口的选举过程。</li>
<li>指派端口(Designated Port,DP)：网络上除根端口外，所有允许转发流量的端口，每个网段都有一个指派端口，<strong>根交换机上的端口都是指派端口</strong>。</li>
<li>非指派端口：既不是根端口也不是指派端口，这种端口虽然是激活的但是会被堵塞(Blocking)用来阻止环路，根端口和指派端口都处于转发(Forwarding)状态。</li>
<li>禁用端口：被管理员使用”shutdown”命令关闭的端口称作禁用端口，禁用端口不参与生成树算法。</li>
</ul>
<h5 id="6、端口状态和BPDU时间"><a href="#6、端口状态和BPDU时间" class="headerlink" title="6、端口状态和BPDU时间"></a>6、端口状态和BPDU时间</h5><p>互连交换机通过在一个广播域交换BPDU帧构建一个逻辑上无环的路径，当一台交换机启动后，如果一个交换机端口直接转换到转发状态可能会造成暂时性的环路。为了使用这个逻辑生成树，交换机需要在五种状态间转换，转换会历经三种BPDU时间。</p>
<p>五种端口状态：</p>
<ul>
<li>Down（禁用）状态，可以使用”no shutdown”命令和插入网线来激活。</li>
<li>Blocking（阻塞）状态，链路激活后转入阻塞状态，这个状态大约停留20秒，主要用来确定该端口的角色；如果判断出该端口是非指派端口，则将保持在这一状态，即阻塞，如果处在阻塞状态的端口接收不到BPDU了，也会转入下一状态；如果判断出是其他端口角色，则转入下一状态。</li>
<li>Listening（侦听）状态，这个状态大约停留15秒，除了接收BPDU外，还向邻居发送BPDU，通知邻居它将参与激活拓扑。</li>
<li>Learning（学习）状态，大约停留15秒，开始学习MAC地址。</li>
<li>Forwarding（转发）状态，端口可以转发数据帧。</li>
</ul>
<p>BPDU的时间有三种：Hello Time、Max Age、Forward Delay：</p>
<ul>
<li>Hello时间控制了发送配置BPDU的时间间隔，默认2秒。这是根交换机生成BPDU并向非根交换机发送的间隔。</li>
<li>非根交换机接收到根交换机发送来的BPDU，再从除接收端口以外的其他端口转发出去，如果在2-20秒里面由于网络故障没有新的BPDU从根交换机发送过来，非根交换机将停止向外发送从根交换机接收到的BPDU。如果这种情况持续20秒，也就是最大存活期，非根交换机就使原储存的BPDU无效，并开始寻找新的根端口。所谓最大存活期就是非根交换机丢弃BPDU前用来备份储存它的时间。</li>
<li>转发延时是交换机在侦听状态到学习状态所花的时间，默认是15秒。</li>
</ul>
<p>一台启动STP的交换机，每个端口从UP到Forwarding所需的时间大约是50秒左右，而普通的二层交换机端口UP到Forwarding瞬间就能完成。这会带来一个问题，那就是如果这台启动STP的交换机的接口连接的是一个终端设备，比如计算机，那么端口加电启动后计算机就要等上50秒才能发送数据，这很不合理，可以使用下面的命令将支持STP的交换机与终端相连的端口设置成快速端口，这样端口从UP到Forwarding也能一瞬间完成了。但要注意，仅在连接计算机的端口上使用快速端口的功能，不要在和其他交换机，集线器网桥相连的端口上使用这个功能，否则很容易造成环路。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*假设这台交换机的fa0/1到10口都连接的是计算机*/</div><div class="line">Switch(config)#int range fa 0/1 - 10</div><div class="line">Switch(config-if-range)#spanning-tree portfast</div></pre></td></tr></table></figure>
<h4 id="STP收敛"><a href="#STP收敛" class="headerlink" title="STP收敛"></a>STP收敛</h4><p>STP的收敛就是整个网络达到稳定的状态，选举出了根交换机，并决定出所有端口的角色，排除所有的潜在环路。</p>
<h5 id="1、STP选举"><a href="#1、STP选举" class="headerlink" title="1、STP选举"></a>1、STP选举</h5><p>STP最终收敛成为一个没有环路的网络需要满足下面四点：</p>
<ul>
<li>每个广播域只能有一个根交换机。</li>
<li>每个非根交换机有且只有一个根端口。</li>
<li>每个网段有且只能有一个指派端口。</li>
<li>既不是根端口也不是指派端口的端口会被阻塞。</li>
</ul>
<p>选举的四个步骤：</p>
<ul>
<li>选举根交换机</li>
</ul>
<p>交换机之间通过发送BPDU来选举根交换机，拥有最小BID的交换机将成为根交换机，每个广播域只能有一个根交换机。</p>
<p>在同一个广播域中的所有交换机都参与选举根交换机，当一台交换机启动时，它假设自己是根交换机，并默认每隔2秒发送一次”次优BPDU”帧，BPDU帧中的Root ID（根交换机的BID）和本机的BID相同。</p>
<p>在一个广播域中的交换机互相转发BPDU帧，并且从接收到的BPDU中读取Root ID，如果读取到的Root ID比本交换机的BID小，交换机更新Root ID为这个较小的Root ID，然后继续转发修改后的BPDU；如果接收的BPDU中的Root ID比本交换机的BID大，那么继续将自己的BID作为Root ID向外发送BPDU，直到最后在同一个生成树实例中拥有一致的Root ID，这个Root ID对应了这个广播域中某台交换机的BID（并且这个BID一定是这个广播域最小的），这台交换机就被选作根交换机。</p>
<ul>
<li>选举根端口</li>
</ul>
<p>每个非根交换机<strong>有且只有一个</strong>根端口</p>
<blockquote>
<p>端口ID（2Byte）:</p>
<p>​    端口优先级+端口ID</p>
<p>​    端口优先级（1字节）：缺省优先级为128，范围为1-255，越小越好。</p>
<p>​    端口ID默认为128    </p>
</blockquote>
<p>选举依据    </p>
<blockquote>
<p>1、比较交换机端口的根路径成本。根路径成本低的为根端口：根路径成本，网桥到根网桥的路径上所有链路的成本之和。</p>
<p>2、当根路径成本相同的时候，比较<strong>直连的交换机的网桥ID</strong>。选择网桥ID小的作为根端口。</p>
<p>3、当网桥ID相同的时候，比较<strong>直连端口ID</strong>，选择较小的作为根端口。</p>
<p>4、如果发送者的PID也相同，那么比较接收者的PID。</p>
</blockquote>
<p>在SW1上查看生成树信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SW1#show spanning-tree</div><div class="line">/*</div><div class="line"> * 这一部分信息就是SW1上面的端口信息，其中Prio下面的就是端口ID，</div><div class="line"> * 可以看到SW1的fa0/1默认端口ID是128.1，小于fa0/2的端口ID。</div><div class="line"> */</div><div class="line">Interface Role Sts Cost  Prio.Nbr Type</div><div class="line">-------   ---- --- ----  ----     ----</div><div class="line">Fa0/1     Desg FWD 19    128.1    P2p</div><div class="line">Fa0/2     Desg FWD 19    128.2    P2p</div></pre></td></tr></table></figure>
<p>从输出可以看到，SW1上面的fa0/1拥有较小的端口ID，它对应了SW2的fa0/2端口，所以SW2的fa0/2端口被选举成为根端口。</p>
<p>如果发送者的PID也相同，那么比较接收者的PID,如果SW1的fa0/1连接在一台集线器上，SW2的fa0/1和fa0/2也连接在这台集线器上，线路均为100Mb/s，假设SW1拥有较小的BID被选举成根交换机，SW2现在要选举根端口，首先根据前面说的，比较花费，SW2从两个端口到根交换机SW1的花费都相同；然后SW2比较发送者BID，发送者（SW1）的BID也相同；SW2再比较发送者PID，发现发送者PID也相同（都为SW1的fa0/1端口）；这个时候，SW2比较接收者，也就是自己的PID，将自己PID最小的那个端口选举成根端口。</p>
<p>可以根据SW2的生成树信息输出判断，fa0/1拥有更小的PID，所以它被选举成为根端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SW2#show spanning-tree</div><div class="line">/*</div><div class="line"> * 下面这一部分可以看到fa0/1拥有更小的PID 128.1,</div><div class="line"> * Root FWD 表示这个端口被选举成为了根端口，并且状态是转发，</div><div class="line"> * Altn BLK 表示这个端口既不是根端口也不是指派端口，被阻塞。</div><div class="line"> */</div><div class="line">Interface Role Sts Cost  Prio.Nbr Type</div><div class="line">-------   ---- --- ----- -------- ----</div><div class="line">Fa0/1     Root FWD 19    128.1    Shr</div><div class="line">Fa0/2     Altn BLK 19    128.2    Shr</div><div class="line"> </div><div class="line">/*</div><div class="line"> * 这里补充一个知识点，端口的优先级默认为128,</div><div class="line"> * 而这个端口优先级是可以手动修改的，</div><div class="line"> * 可以将fa0/2的优先级通过下面的命令改成100，</div><div class="line"> * STP重新收敛后，Fa0/1将被阻塞，Fa0/2将被选举成为根端口,</div><div class="line"> * 端口优先级的取值范围一般为0-192或0-255，</div><div class="line"> * Cisco Packet Tracer中不支持这一条命令，可以在GNS3中测试。</div><div class="line"> */</div><div class="line">SW2(config)#int fa 0/2</div><div class="line">SW2(config-if)#spanning-tree port-priority 100</div><div class="line">/*在GNS3+IOU环境中，重新调整端口优先级后需要手动触发一次根交换机的选举才能让端口改变状态，比如手动在根交换机上配置一个较小的优先级*/</div></pre></td></tr></table></figure>
<ul>
<li>选举指派端口</li>
</ul>
<p>每个网段有且只有一个指派端口。其实，每个网段都有一个指派交换机，指派交换机上如果有多个端口，再从多个端口中选举出一个成为指派端口，指派端口的选举依照下面的顺序：</p>
<p>1、比较花费；<br><img src="./image.png" alt="Alt text"></p>
<p>在此基础上，计算每个节点到根桥的距离，并由这些路径得到各冗余链路的代价，选择最小的成为通信路径（相应的端口状态变为forwarding），其它的就成为备份路径(相应的端口状态变为blocking)。</p>
<p>STP生成过程中的通信任务由BPDU完成，这种数据包又分为包含配置信息的配置BPDU（其大小不超过35B）和包含拓扑变化信息的通知BPDU（其长度不超过4B）。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://super-flanker.com/2017/04/14/STP协议详解/" data-id="cj1h9drnm00010c4i57efce8a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络协议/">网络协议</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/03/30/SNMP配置及命令参数/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">SNMP配置及命令参数</div>
    </a>
  
</nav>

  
</article>

</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a href="/" class="logo">connect();</a>
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    

<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollLoading.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>